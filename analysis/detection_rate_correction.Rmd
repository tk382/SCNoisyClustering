---
  title: "Effects of Correction of Detection Rate"
site: workflowr::wflow_site
output:
  workflowr::wflow_html:
  theme: yeti
highlight: tango
toc: false
toc_float:
  collapsed: true
smooth_scroll: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      warning = FALSE, 
                      message = FALSE, 
                      comment = NA)
library(SCNoisyClustering)
library(matrixStats)
library(inline)
library(quadprog)
library(irlba)
library(ggplot2)
library(dplyr)
library(reshape)
library(caret)
library(fossil)
library(pracma)
library(scatterplot3d)
library(igraph) #for nmi
library(Rtsne)
library(diceR)
library(gplots)
library(broom)
library(abind)
library(gdata)

library(stargazer)

set.seed(1)
# R.utils::sourceDirectory("../../R/", modifiedOnly=FALSE)
# Rcpp::sourceCpp('../../src/SCNoisyClustering.cpp')

heat = function(S){
  ggplot(melt(S), aes(x=X1, y=X2, fill=value)) + geom_tile() + scale_fill_gradient()
}
```

```{r initialize}
cellcount   = rep(0,8)
genecount   = rep(0,8)
detection   = rep(0,8)
ARI         = data.frame("BEFORE" = rep(0,8), "AFTER" = rep(0,8))
data_list     = c('Kolod','Pollen','Usoskin','Buettner',
                  'Yan','Treutlein','Chu1','Chu2')
correction    = c("BEFORE", "AFTER")

```

```{r Kolod, eval=F}
i = 1
load('../data/unnecessary_in_building/1_Kolod.RData')
X        = exp(Test_2_Kolod$in_X)-1;
truth    = Test_2_Kolod$true_labs$V1
numClust = Test_2_Kolod$n_clust;
rm(Test_2_Kolod)

cellcount[i] = ncol(X)
genecount[i] = nrow(X)


logX = log(X+1)

det = colSums(X!=0) / nrow(X)

det2 = qr(det)
R = t(qr.resid(det2, t(logX)))

plot(irlba(logX,1)$v[,1], det)
plot(irlba(R,1)$v[,1], det)

#clustering on R
remove = which((apply(R, 2, var))<1.0)
R = R[-remove,]

#build kernel
diff1 = 1-cor(as.matrix(R), method = "pearson")
diff3 = 1-cor(as.matrix(R), method = "spearman")
P1 = corr_kernel_c(t(R), diff1, c(15,20,25), seq(1,2,by=0.2), 20)
P2 = dist_kernel_c(t(R), c(15,20,25), seq(1,2,by=0.2), 20)
P3 = rank_kernel_c(t(R), diff3, c(15,20,25), seq(1,2,by=0.2), 20)
P  = abind(P1, P2, P3)
rm(P1, P2, P3)

```

```{r Pollen}
i = 2

getwd()
load('../data/unnecessary_in_building/2_Pollen.RData')
X        = as.matrix(Pollen$x)
zeros = colSums(X==0)
ind = which(zeros < 3500)
X = X[,ind]
truth    = Pollen$label
truth = truth[ind]
numClust = 11
rm(Pollen)

logX = log(X+1)

det = colSums(X!=0) / nrow(X)

det2 = qr(det)
R = t(qr.resid(det2, t(logX)))

plot(irlba(logX,1)$v[,1], det)
plot(irlba(R,1)$v[,1], det)


```

```{r Usoskin}
i = 3

load('../data/unnecessary_in_building/3_Usoskin.RData')
X        = as.matrix(Usoskin$X)
truth    = as.character(Usoskin$lab1)
numClust = 4
rm(Usoskin)

logX = log(X+1)

det = colSums(X!=0) / nrow(X)

det2 = qr(det)
R = t(qr.resid(det2, t(logX)))

plot(irlba(logX,1)$v[,1], det)
plot(irlba(R,1)$v[,1], det)
```

```{r Buettner}
i = 4

#read data
load('../data/unnecessary_in_building/4_Buettner.RData')
X        = as.matrix(Buettner$X)
truth    = as.character(Buettner$label)
numClust = 3
rm(Buettner)
ind1 = which(colSums(X==0) > 35000)
X = X[,-ind1]; truth = truth[-ind1]
v2 = irlba(X,2)$v[,2]
ind2 = which(abs(v2-mean(v2)) > iqr(v2) * 1.5)
X = X[,-ind2]; truth = truth[-ind2]

logX = log(X+1)

det = colSums(X!=0) / nrow(X)

det2 = qr(det)
R = t(qr.resid(det2, t(logX)))

plot(irlba(logX,1)$v[,1], det)
plot(irlba(R,1)$v[,1], det)
```

```{r Yan}
i = 5

load('../data/unnecessary_in_building/5_Yan.rda')
X        = as.matrix(yan)
truth    = as.character(ann$cell_type1)
numClust = 6
rm(ann, yan)

logX = log(X+1)

det = colSums(X!=0) / nrow(X)

det2 = qr(det)
R = t(qr.resid(det2, t(logX)))

plot(irlba(logX,1)$v[,1], det)
plot(irlba(R,1)$v[,1], det)
```

```{r Treutlein}
i = 6

load('../data/unnecessary_in_building/6_Treutlein.rda')
X        = as.matrix(treutlein)
truth    = as.numeric(colnames(treutlein))
ind      = sort(truth, index.return=TRUE)$ix
X        = X[,ind]
truth    = truth[ind]
numClust = length(unique(truth))
rm(treutlein)

logX = log(X+1)

det = colSums(X!=0) / nrow(X)

det2 = qr(det)
R = t(qr.resid(det2, t(logX)))

plot(irlba(logX,1)$v[,1], det)
plot(irlba(R,1)$v[,1], det)
```

```{r Chu_celltype}
i = 7

load('../data/unnecessary_in_building/7_Chu_celltype.Rdata')
X        = as.matrix(Chu_celltype$X)
truth    = Chu_celltype$label
numClust = 7

logX = log(X+1)

det = colSums(X!=0) / nrow(X)

det2 = qr(det)
R = t(qr.resid(det2, t(logX)))

plot(irlba(logX,1)$v[,1], det)
plot(irlba(R,1)$v[,1], det)
```

```{r Chu_timecourse}
i = 8
load('../data/unnecessary_in_building/8_Chu_timecourse.Rdata')
X        = as.matrix(Chu_timecourse$X)
truth    = Chu_timecourse$label
numClust = length(unique(truth))

logX = log(X+1)

det = colSums(X!=0) / nrow(X)

det2 = qr(det)
R = t(qr.resid(det2, t(logX)))

plot(irlba(logX,1)$v[,1], det)
plot(irlba(R,1)$v[,1], det)
```

```{r read data, eval=F}
  detection[i] = mean(colSums(X!=0)/nrow(X))
  cellcount[i] = ncol(X)
  genecount[i] = nrow(X)
  gc()

  ####################################

  truth = as.numeric(as.factor(truth))
  #
  # set.seed(1)
  # res = SLSL(X,
  #            numClust = numClust,
  #            correct_detection_rate = T,
  #            tau = 5,
  #            gamma = 0,
  #            kernel_type = "spearman"
  #            )
  # ARI[i,1] = adj.rand.index(res$result, truth)
  # gc()
  #
  # set.seed(1)
  # res = SLSL(X,
  #            numClust = numClust,
  #            correct_detection_rate = T,
  #            tau = 5,
  #            gamma = 0,
  #            kernel_type = "pearson"
  #            )
  # ARI[i,2] = adj.rand.index(res$result, truth)
  # gc()
  #
  # set.seed(1)
  # res = SLSL(X,
  #            numClust = numClust,
  #            correct_detection_rate = T,
  #            tau = 5,
  #            gamma = 0,
  #            kernel_type = "euclidean"
  #            )
  # ARI[i,3] = adj.rand.index(res$result, truth)
  # gc()
  #
  set.seed(1)
  t1 = Sys.time()
  res = SLSL(X,
             numClust = numClust,
             correct_detection_rate = T,
             tau = 5,
             gamma = 0,
             kernel_type = "combined"
  )

  res2 = SLSL(X,
              numClust = numClust,
              correct_detection_rate = F,
              tau = 5,
              gamma = 0,
              kernel_type = "combined"
  )

  t2 = Sys.time()
  ARI[i,4] = adj.rand.index(res$result, truth)
  ARI[i,3] = adj.rand.index(res2$result, truth)
  gc()

  measuretime[i,1] = as.difftime(t2-t1, units="secs")

  print(data_list[i])
  rm(res)
  gc()

  # #SC3
  # set.seed(1)
  # colnames(X) = paste0('C',1:ncol(X))
  # rownames(X) = paste0('R',1:nrow(X))
  # sce = SingleCellExperiment(assays = list(counts = X,
  #                                          logcounts = log(X + 1)
  #                                          ),
  #                            colData = colnames(X)
  #                            )
  # rowData(sce)$feature_symbol = rownames(X)
  # t3 = Sys.time()
  # res = sc3(sce, ks = numClust, biology = FALSE)
  # t4 = Sys.time()
  #
  # measuretime[i,2] = as.difftime(t4-t3, units="secs")
  #
  # sc3_export_results_xls(res, filename = "tmp.xls")
  # x = read.xls("tmp.xls")
  # result = x[,2]
  # SC3[i] = adj.rand.index(result, truth)
  #
  # set.seed(1)
  # t5 = Sys.time()
  # res = PCAreduce(t(log(X+1)), 10, numClust, 'M')[[1]][,1]
  # t6 = Sys.time()
  #
  # measuretime[i,3] = as.difftime(t6-t5, units="secs")
  #
  # pcaReduce[i] = adj.rand.index(res, truth)
  #
  # set.seed(1)
  #
  # t7 = Sys.time()
  # res = SIMLR(log(X+1), numClust)
  # t8 = Sys.time()
  #
  # measuretime[i,4] = as.difftime(t8-t7, units = "secs")
  #
  # SIMLR[i] = adj.rand.index(res$y$cluster, truth)
  #
  # rm(res); gc()
}
write.table(measuretime, "temp_time.txt", col.names=TRUE, row.names=TRUE, quote=FALSE)
write.table(ARI, "temp_ari.txt", col.names=TRUE, row.names=TRUE, quote=FALSE)

```




```{r}
library(knitr)
measuretime = read.table('small_good_sets_time.txt', header=TRUE)
cellcount = measuretime$cellcount
measuretime = measuretime[,1:4]
dat = read.table('small_good_sets_result.txt', header=TRUE)

#dat = cbind(ARI, SIMLR, SC3, pcaReduce)
colnames(dat) = c('Spearman','Pearson','Euclidean','SLSL','SIMLR','SC3','pcaReduce')
ind = sort(rownames(dat), index.return=TRUE)$ix
stargazer(as.matrix(dat[ind,]))
dat = as.data.frame(dat)
dat$data = c("Kolod","Pollen","Usoskin","Buettner","Yan","Treutlein","Chu(celltype)","Chu(timecourse)")

md = melt(dat, id='data')
md2 = md[md$variable %in% c('SLSL','pcaReduce','SIMLR','SC3'), ]
md2$detection = rep(detection, 4)
md2$genecount = rep(genecount, 4)
md3 = md2
#md3 = md2[md2$data %in% c('Buettner','Chu(celltype)', 'Chu(timecourse)', 'Treutlein','Pollen', 'Usoskin', 'Yan', 'Kolod'), ]


ggplot(md3, aes(x=variable, y=value)) + geom_bar(stat="identity") + facet_grid(. ~data ) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  xlab("") + ylab("Adjusted Rand Index")
ggsave('../writeup/small_good_data_sets_result.png', width=10, height=5)

ggplot(md3, aes(x=genecount, y=value, col=variable)) + geom_point(label=data) + geom_line()


#write.table(measuretime, 'small_good_sets_time.txt', col.names=TRUE, row.names=TRUE, quote=FALSE)
ind = sort(cellcount, index.return=TRUE)$ix
stargazer(as.matrix(cbind(cellcount[ind], measuretime[ind, ])))

measuretime$data = c("Kolod","Pollen","Usoskin","Buettner","Yan","Treutlein","Chu(celltype)","Chu(timecourse)")
mt = melt(measuretime, id='data')
mt$cellcount = cellcount


ggplot(mt, aes(x=cellcount, y=value, col=variable)) + geom_line() +
  geom_point() +
  ylab("time (seconds)") + xlab("number of cells")+ xlim(c(0,1100))+
  geom_text(aes(x=1020, y=500, label="SIMLR", col='SIMLR')) +
  geom_text(aes(x=1020, y=300, label="SC3", col='SC3')) +
  geom_text(aes(x=1020, y=180, label="SLSL", col='SLSL')) +
  geom_text(aes(x=1020, y=50, label="pcaReduce", col='pcaReduce')) +
  theme(legend.position="none")
ggsave('../writeup/small_good_data_sets_time.png', width=10, height=5)


```



