---
title: "Buettner"
author: "Tae Kim"
date: "6/1/2018"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      comment=NA,
                      warning = FALSE,
                      message = FALSE)
library(MultiAssayExperiment)
library(ggplot2)
library(irlba)
library(matrixStats)
library(inline)
library(quadprog)
library(dplyr)
library(reshape)
library(caret)
library(fossil)
library(pracma)
library(scatterplot3d)
library(igraph) #for nmi
library(Rtsne)
library(diceR)
library(gplots)

library(SCNoisyClustering)

# set.seed(1)
# R.utils::sourceDirectory("../../R/", modifiedOnly=FALSE)
# Rcpp::sourceCpp('../../src/SCNoisyClustering.cpp')

library(SC3)
library(SingleCellExperiment)
library(scater)
library(pcaReduce)
library(Rtsne)
library(gdata)
library(SIMLR)
```



```{r read_data}
load('../../data/unnecessary_in_building/4_Buettner.RData')
X = Buettner$X
truth = Buettner$label
truth = as.numeric(as.factor(truth))
```

```{r clean}
tpm = X[rowSums(X>0)>3, ]
remove_cells = which(colSums(X>0)/nrow(X)<0.1)
tpm= tpm[, -remove_cells]
truth = truth[-remove_cells]
print(dim(tpm))
```

```{r quantile_plot}
ngenes = colSums(tpm>0)
det.rate = ngenes/nrow(tpm)
log.tpm = log(tpm + 0.1)

n = ncol(log.tpm)
num.gene = nrow(log.tpm)

quants = apply(log.tpm, 2, function(x) quantile(x[x>0], probs=c(.25, .5, .75, 1)))
type = c(rep('25%',n), rep('50%',n), rep('75%',n), rep('100%',n))
quants.df = data.frame(logTPM = c(t(quants)), quantile=type, detection = rep(det.rate, 4))
ggplot(quants.df, aes(x=detection, y=logTPM, col=quantile))+
  geom_point()+
  ggtitle('Buettner')
```

The first principal component is correlated with the detection rate

```{r pca_plot}
svd.base = irlba(log.tpm, 3)
plot(svd.base$v[,1] ~ det.rate)
```
Remove the effects of detection rate
```{r regress_out}
det2 = qr(det.rate)
log.tpm.rg = t(qr.resid(det2, t(log.tpm)))
svd.rg = irlba(log.tpm.rg, 1)
plot(svd.rg$v[,1] ~ det.rate)
```

There are still the detection rate effect in the first principal component. Try Loess.

```{r loess}
log.tpm.loess = log.tpm
for (i in 1:num.gene){
  fit = loess(log.tpm[i,] ~ det.rate)
  log.tpm.loess[i,] = fit$residuals
}
```

```{r loess_genevar}
#select genes
svd.loess = irlba(log.tpm.loess, 2)
plot(svd.loess$v[,1] ~ det.rate)
```
```{r loess_clustering}
out_loess = SLSL(X = log.tpm.loess, log = F, filter = F, numClust=3, verbose=T)
```

```{r rg_clustering}
out_reg = SLSL(log.tpm.rg, filter=F, log=F, numClust=3)
```



```{r benchmark}
k = kmeans(t(log.tpm.rg.filtered), 3, nstart=5)$cluster
s = SIMLR(log.tpm.rg.filtered, 3)
p = PCAreduce(t(log.tpm.rg.filtered), 10, 3, 'M')[[1]][,1]
colnames(log.tpm.rg.filtered) = paste0('C',1:ncol(log.tpm.rg.filtered))
rownames(log.tpm.rg.filtered) = paste0('R',1:nrow(log.tpm.rg.filtered))
sce = SingleCellExperiment(
  assays = list(
    counts = exp(as.matrix(log.tpm.rg.filtered))-1,
    logcounts = as.matrix(log.tpm.rg.filtered)
    ),
  colData = colnames(log.tpm.rg.filtered)
)
rowData(sce)$feature_symbol = rownames(log.tpm.rg.filtered)
sc = sc3(sce, ks = 3, biology = FALSE, gene_filter=FALSE)
sc3_export_results_xls(sc, filename = paste0("sc", ".xls"))
x = read.xls(paste0("sc", ".xls"))
scr = x[,2]

print(paste('kmeans    : ',adj.rand.index(k, as.numeric(label))))
print(paste('SIMLR     : ',adj.rand.index(s$y$cluster, as.numeric(label))))
print(paste('pcaReduce : ',adj.rand.index(p, as.numeric(label))))
print(paste('SC3       : ',adj.rand.index(scr, as.numeric(label))))
print(paste('SSL       : ',adj.rand.index(out_reg$result, as.numeric(label))))
```



```{r original result}
out_orig = ssl_wrapper(log.tpm, numClust=3)
k = kmeans(t(log.tpm), 3, nstart=5)$cluster
s = SIMLR(log.tpm, 3)
p = PCAreduce(t(log.tpm), 10, 3, 'M')[[1]][,1]
colnames(log.tpm) = paste0('C',1:ncol(log.tpm))
rownames(log.tpm) = paste0('R',1:nrow(log.tpm))
sce = SingleCellExperiment(
  assays = list(
    counts = exp(as.matrix(log.tpm))-1,
    logcounts = as.matrix(log.tpm)
    ),
  colData = colnames(log.tpm)
)
rowData(sce)$feature_symbol = rownames(log.tpm)
sc = sc3(sce, ks = 3, biology = FALSE, gene_filter=FALSE)
sc3_export_results_xls(sc, filename = paste0("sc", ".xls"))
x = read.xls(paste0("sc", ".xls"))
scr = x[,2]

print(paste('kmeans    : ',adj.rand.index(k, as.numeric(label))))
print(paste('SIMLR     : ',adj.rand.index(s$y$cluster, as.numeric(label))))
print(paste('pcaReduce : ',adj.rand.index(p, as.numeric(label))))
print(paste('SC3       : ',adj.rand.index(scr, as.numeric(label))))
print(paste('SSL       : ',adj.rand.index(out_orig$result, as.numeric(label))))
```
