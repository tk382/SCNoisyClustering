---
title: "Pollen"
author: "Tae Kim"
date: "6/1/2018"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      comment=NA,
                      warning=FALSE,
                      message=FALSE)
library(MultiAssayExperiment)
library(ggplot2)
library(irlba)
library(matrixStats)
library(inline)
library(quadprog)
library(dplyr)
library(reshape)
library(caret)
library(fossil)
library(pracma)
library(scatterplot3d)
library(igraph) #for nmi
library(Rtsne)
library(diceR)
library(gplots)
library(data.table)
set.seed(1)
R.utils::sourceDirectory("../../R/", modifiedOnly=FALSE)
Rcpp::sourceCpp('../../src/SCNoisyClustering.cpp')
```


```{r read_data}
tpm_orig = read.csv('../../../benchmark/pcaReduce-master/Pollen2014.txt', header=TRUE)
label = as.factor(sapply(strsplit(colnames(tpm_orig), '_'), function(x) x[2]))
```

```{r clean}
tpm = tpm_orig[rowSums(tpm_orig>0)>3, ]
print(dim(tpm))
```

```{r quantile_plot}
ngenes = colSums(tpm>0)
det.rate = ngenes/nrow(tpm)
log.tpm = log(tpm + 1)

n = ncol(log.tpm)
num.gene = nrow(log.tpm)

quants = apply(log.tpm, 2, function(x) quantile(x[x>0], probs=c(.25, .5, .75, 1)))
type = c(rep('25%',n), rep('50%',n), rep('75%',n), rep('100%',n))
quants.df = data.frame(logTPM = c(t(quants)), quantile=type, detection = rep(det.rate, 4))
ggplot(quants.df, aes(x=detection, y=logTPM, col=quantile))+
  geom_point()+
  ggtitle('log TPM ~ log(detection)')
```

The first principal component is correlated with the detection rate

```{r pca_plot}
svd.base = irlba(as.matrix(log.tpm), 3)
plot(svd.base$v[,1] ~ det.rate)
```

Remove the effects of detection rate
```{r regress_out}
x = det.rate - mean(det.rate)
log.tpm.rg = t(t(scale(log.tpm)) - x %*% t(x) %*% t(scale(log.tpm))/sum(x^2))

gene.var = apply(log.tpm.rg, 1, var)
gene.mean = rowMeans(log.tpm.rg)
var.genes = names(gene.var[gene.var>quantile(gene.var, 0.3)])
log.tpm.rg.filtered = log.tpm.rg[var.genes,]
svd.rg = irlba(log.tpm.rg.filtered, 2)
plot(svd.rg$v[,1] ~ det.rate)
```

Trying loess..

```{r loess}
log.tpm.loess = log.tpm
for (i in 1:num.gene){
  fit = loess(as.numeric(log.tpm[i,]) ~ det.rate)
  log.tpm.loess[i,] = fit$residuals
}
log.tpm.loess = as.matrix(log.tpm.loess)
```

```{r loess_genevar}
#select genes
gene.var = apply(log.tpm.loess, 1, var)
gene.mean = rowMeans(log.tpm.loess)
var.genes = names(gene.var[gene.var>quantile(gene.var, 0.3)])
log.tpm.loess.filtered = log.tpm.loess[var.genes, ]
svd.loess = irlba(log.tpm.loess.filtered, 2)
plot(svd.loess$v[,1] ~ det.rate)
```


```{r benchmark}
library(SIMLR)
library(pcaReduce)
library(SingleCellExperiment)
library(SC3)
library(gdata)

out.rg = ssl_wrapper(log.tpm.rg.filtered, numClust=11)
k = kmeans(t(log.tpm.rg.filtered), 11, nstart=5)$cluster
s = SIMLR(log.tpm.rg.filtered, 11)
p = PCAreduce(t(log.tpm.rg.filtered), 10, 11, 'M')[[1]][,1]
colnames(log.tpm.rg.filtered) = paste0('C',1:ncol(log.tpm.rg.filtered))
rownames(log.tpm.rg.filtered) = paste0('R',1:nrow(log.tpm.rg.filtered))
sce = SingleCellExperiment(
  assays = list(
    counts = exp(as.matrix(log.tpm.rg.filtered))-1,
    logcounts = as.matrix(log.tpm.rg.filtered)
  ),
  colData = colnames(log.tpm.rg.filtered)
)
rowData(sce)$feature_symbol = rownames(log.tpm.rg.filtered)
sc = sc3(sce, ks = 11, biology = FALSE, gene_filter=FALSE)
sc3_export_results_xls(sc, filename = paste0("sc", ".xls"))
x = read.xls(paste0("sc", ".xls"))
scr = x[,2]
  
print(paste('kmeans    : ',adj.rand.index(k, as.numeric(label))))
print(paste('SIMLR     : ',adj.rand.index(s$y$cluster, as.numeric(label))))
print(paste('pcaReduce : ',adj.rand.index(p, as.numeric(label))))
print(paste('SC3       : ',adj.rand.index(scr, as.numeric(label))))
print(paste('SSL       : ',adj.rand.index(out.rg$result, as.numeric(label))))
```

Without regressing out the detection effect..

```{r original}
out = ssl_wrapper(log.tpm, numClust=11)
k = kmeans(t(log.tpm), 11, nstart=5)$cluster
s = SIMLR(log.tpm, 11)
p = PCAreduce(t(log.tpm), 10, 11, 'M')[[1]][,1]
colnames(log.tpm) = paste0('C',1:ncol(log.tpm))
rownames(log.tpm) = paste0('R',1:nrow(log.tpm))
sce = SingleCellExperiment(
  assays = list(
    counts = exp(as.matrix(log.tpm))-1,
    logcounts = as.matrix(log.tpm)
  ),
  colData = colnames(log.tpm)
)
rowData(sce)$feature_symbol = rownames(log.tpm)
sc = sc3(sce, ks = 11, biology = FALSE, gene_filter=FALSE)
sc3_export_results_xls(sc, filename = paste0("sc", ".xls"))
x = read.xls(paste0("sc", ".xls"))
scr = x[,2] 
  
print(paste('kmeans    : ',adj.rand.index(k, as.numeric(label))))
print(paste('SIMLR     : ',adj.rand.index(s$y$cluster, as.numeric(label))))
print(paste('pcaReduce : ',adj.rand.index(p, as.numeric(label))))
print(paste('SC3       : ',adj.rand.index(scr, as.numeric(label))))
print(paste('SSL       : ',adj.rand.index(out$result, as.numeric(label))))
```

